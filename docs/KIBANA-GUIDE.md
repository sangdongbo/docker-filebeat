# Kibana æ—¥å¿—æŸ¥çœ‹æŒ‡å—

## ðŸš€ å¿«é€Ÿå¼€å§‹

### 1. è®¿é—® Kibana
```
URL: http://localhost:5601
ç”¨æˆ·å: elastic
å¯†ç : Es123456
```

### 2. é¦–æ¬¡é…ç½® Data View

1. ç‚¹å‡»å·¦ä¸Šè§’èœå• â˜° â†’ **Management** â†’ **Stack Management**
2. åœ¨å·¦ä¾§èœå•é€‰æ‹© **Kibana** â†’ **Data Views**
3. ç‚¹å‡»å³ä¸Šè§’ **Create data view** æŒ‰é’®
4. å¡«å†™ä¿¡æ¯ï¼š
   - **Name**: `Laravel Logs`
   - **Index pattern**: `laravel-logs-*`
   - **Timestamp field**: `@timestamp`
5. ç‚¹å‡» **Save data view to Kibana**

### 3. æŸ¥çœ‹æ—¥å¿—

1. ç‚¹å‡»å·¦ä¸Šè§’èœå• â˜° â†’ **Analytics** â†’ **Discover**
2. åœ¨é¡¶éƒ¨é€‰æ‹©åˆšæ‰åˆ›å»ºçš„ `Laravel Logs` data view
3. è®¾ç½®æ—¶é—´èŒƒå›´ï¼ˆå³ä¸Šè§’æ—¶é’Ÿå›¾æ ‡ï¼‰â†’ é€‰æ‹© **Last 24 hours** æˆ– **Last 7 days**
4. çŽ°åœ¨ä½ å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„ Laravel æ—¥å¿—äº†ï¼

## ðŸ“Š å¸¸ç”¨æœç´¢æŸ¥è¯¢

### åŸºç¡€æœç´¢

åœ¨æœç´¢æ¡†ä¸­è¾“å…¥ KQL (Kibana Query Language) æŸ¥è¯¢ï¼š

```
# æœç´¢é”™è¯¯æ—¥å¿—
level: ERROR

# æœç´¢ç‰¹å®šæ—¥å¿—é¢‘é“
log_channel: "api"

# æœç´¢æ”¯ä»˜ç›¸å…³æ—¥å¿—
log_channel: "payment"

# æœç´¢è¯·æ±‚æ—¥å¿—
log_channel: "request"

# ç»„åˆæ¡ä»¶ï¼šAPI é¢‘é“çš„é”™è¯¯æ—¥å¿—
log_channel: "api" AND level: ERROR

# æœç´¢åŒ…å«ç‰¹å®šå…³é”®è¯çš„æ—¥å¿—
log_message: *æ”¯ä»˜*

# æœç´¢ç‰¹å®š IP çš„è¯·æ±‚
message: *127.0.0.1*
```

### é«˜çº§æœç´¢

```
# æœç´¢ç‰¹å®šæ—¶é—´èŒƒå›´çš„æ—¥å¿—
@timestamp >= "2026-01-20T00:00:00" AND @timestamp < "2026-01-20T23:59:59"

# æœç´¢çŠ¶æ€ç ä¸º 200 çš„è¯·æ±‚
log_message: *"status":200*

# æœç´¢æ¥è‡ªç‰¹å®š User-Agent çš„è¯·æ±‚
log_message: *curl* OR log_message: *Postman*

# æŽ’é™¤æŸäº›æ—¥å¿—
NOT level: DEBUG
```

## ðŸŽ¨ åˆ›å»ºå¯è§†åŒ–

### 1. æ—¥å¿—çº§åˆ«åˆ†å¸ƒï¼ˆé¥¼å›¾ï¼‰

1. ç‚¹å‡»å·¦ä¾§èœå• â†’ **Visualize Library** â†’ **Create visualization**
2. é€‰æ‹© **Pie**
3. é€‰æ‹© `Laravel Logs` data view
4. é…ç½®ï¼š
   - **Slice by**: `level.keyword`
   - **Metric**: Count
5. ä¿å­˜ä¸º "æ—¥å¿—çº§åˆ«åˆ†å¸ƒ"

### 2. æ¯å°æ—¶æ—¥å¿—è¶‹åŠ¿ï¼ˆæŠ˜çº¿å›¾ï¼‰

1. åˆ›å»ºæ–°å¯è§†åŒ– â†’ é€‰æ‹© **Line**
2. é…ç½®ï¼š
   - **Horizontal axis**: `@timestamp` (Date histogram)
   - **Interval**: `1 hour`
   - **Vertical axis**: Count
   - **Break down by**: `log_channel.keyword`
3. ä¿å­˜ä¸º "æ—¥å¿—è¶‹åŠ¿"

### 3. Top 10 è®¿é—®çš„ URL

1. åˆ›å»ºæ–°å¯è§†åŒ– â†’ é€‰æ‹© **Bar**  
2. é…ç½®ï¼š
   - **Horizontal axis**: Top 10 values of `log_message.keyword`
   - **Vertical axis**: Count
3. æ·»åŠ è¿‡æ»¤å™¨: `log_message: *url*`
4. ä¿å­˜ä¸º "çƒ­é—¨ API"

## ðŸ“ˆ åˆ›å»º Dashboard

1. ç‚¹å‡»å·¦ä¾§èœå• â†’ **Dashboard** â†’ **Create dashboard**
2. ç‚¹å‡» **Add from library** æ·»åŠ åˆšæ‰åˆ›å»ºçš„å¯è§†åŒ–
3. æ‹–æ‹½è°ƒæ•´å¸ƒå±€
4. ä¿å­˜ Dashboard ä¸º "Laravel æ—¥å¿—ç›‘æŽ§"

## ðŸ” å®žç”¨å­—æ®µè¯´æ˜Ž

| å­—æ®µ | è¯´æ˜Ž | ç¤ºä¾‹ |
|------|------|------|
| `@timestamp` | æ—¥å¿—æ—¶é—´æˆ³ | 2026-01-20T07:55:05 |
| `level` | æ—¥å¿—çº§åˆ« | INFO, WARNING, ERROR |
| `log_channel` | æ—¥å¿—é¢‘é“ | default, api, payment, request |
| `log_message` | æ—¥å¿—æ¶ˆæ¯å†…å®¹ | è·¯ç”±è®¿é—®æ—¥å¿— {...} |
| `environment` | çŽ¯å¢ƒ | local, production |
| `host.ip` | ä¸»æœº IP | 172.20.0.6 |
| `app` | åº”ç”¨æ ‡è¯† | laravel |

## âš¡ å¿«æ·æ“ä½œ

### æ·»åŠ å­—æ®µåˆ°è¡¨æ ¼

1. åœ¨ Discover é¡µé¢å·¦ä¾§å­—æ®µåˆ—è¡¨ä¸­
2. ç‚¹å‡»å­—æ®µåæ—è¾¹çš„ âž• å›¾æ ‡
3. æŽ¨èæ·»åŠ çš„å­—æ®µï¼š
   - `@timestamp`
   - `level`
   - `log_channel`
   - `log_message`
   - `environment`

### è¿‡æ»¤ç‰¹å®šå€¼

1. åœ¨æ—¥å¿—åˆ—è¡¨ä¸­æ‰¾åˆ°ä»»æ„å­—æ®µå€¼
2. é¼ æ ‡æ‚¬åœåœ¨å€¼ä¸Š
3. ç‚¹å‡» ðŸ”+ å›¾æ ‡æ·»åŠ è¿‡æ»¤ï¼ˆåŒ…å«ï¼‰
4. æˆ–ç‚¹å‡» ðŸ”- å›¾æ ‡æ·»åŠ è¿‡æ»¤ï¼ˆæŽ’é™¤ï¼‰

### ä¿å­˜æœç´¢

1. åœ¨æœç´¢æ¡†è¾“å…¥æŸ¥è¯¢æ¡ä»¶
2. ç‚¹å‡»é¡¶éƒ¨ **Save** æŒ‰é’®
3. ç»™æœç´¢å‘½åï¼Œå¦‚ "API é”™è¯¯æ—¥å¿—"
4. ä¸‹æ¬¡å¯ä»¥ä»Ž **Open** æŒ‰é’®å¿«é€ŸåŠ è½½

## ðŸŽ¯ ç›‘æŽ§æœ€ä½³å®žè·µ

### 1. åˆ›å»ºè­¦æŠ¥

è¿›å…¥ **Stack Management** â†’ **Rules and Connectors**ï¼š

```
æ¡ä»¶: å½“ 5 åˆ†é’Ÿå†… ERROR çº§åˆ«æ—¥å¿—è¶…è¿‡ 10 æ¡æ—¶è§¦å‘
åŠ¨ä½œ: å‘é€é‚®ä»¶é€šçŸ¥
```

### 2. å®šæœŸæ¸…ç†æ—§æ—¥å¿—

```bash
# åˆ é™¤ 30 å¤©å‰çš„æ—¥å¿—ç´¢å¼•
curl -X DELETE -u elastic:Es123456 \
  "http://localhost:9200/laravel-logs-*-2025.12.*"
```

### 3. ç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç† (ILM)

åœ¨ Kibana ä¸­é…ç½®è‡ªåŠ¨åˆ é™¤ç­–ç•¥ï¼š
- **Hot é˜¶æ®µ**: æœ€è¿‘ 7 å¤©ï¼Œä¿æŒæ‰€æœ‰å‰¯æœ¬
- **Warm é˜¶æ®µ**: 7-30 å¤©ï¼Œå‡å°‘å‰¯æœ¬
- **Delete é˜¶æ®µ**: 30 å¤©åŽè‡ªåŠ¨åˆ é™¤

## ðŸ”— æœ‰ç”¨çš„é“¾æŽ¥

- Kibana å®˜æ–¹æ–‡æ¡£: https://www.elastic.co/guide/en/kibana/current/index.html
- KQL æŸ¥è¯¢è¯­æ³•: https://www.elastic.co/guide/en/kibana/current/kuery-query.html
- å¯è§†åŒ–ç±»åž‹: https://www.elastic.co/guide/en/kibana/current/dashboard.html

## ðŸ’¡ å°è´´å£«

1. **ä½¿ç”¨æ—¶é—´èŒƒå›´é€‰æ‹©å™¨**: å‡å°‘æŸ¥è¯¢çš„æ•°æ®é‡å¯ä»¥æé«˜æ€§èƒ½
2. **ä¿å­˜å¸¸ç”¨æœç´¢**: ç»å¸¸ä½¿ç”¨çš„æŸ¥è¯¢å¯ä»¥ä¿å­˜èµ·æ¥
3. **ä½¿ç”¨è¿‡æ»¤å™¨**: æ¯”åœ¨æœç´¢æ¡†è¾“å…¥æ›´ç›´è§‚
4. **å¯¼å‡ºæ•°æ®**: å¯ä»¥å°†æŸ¥è¯¢ç»“æžœå¯¼å‡ºä¸º CSV
5. **åˆ†äº« Dashboard**: å¯ä»¥ç”Ÿæˆåˆ†äº«é“¾æŽ¥ç»™å›¢é˜Ÿæˆå‘˜

## ðŸ§ª æµ‹è¯•æ•°æ®

è®¿é—®ä»¥ä¸‹æŽ¥å£ç”Ÿæˆæµ‹è¯•æ—¥å¿—ï¼š

```bash
# ç”Ÿæˆå¤šç§ç±»åž‹çš„æ—¥å¿—
curl http://127.0.0.1:8080/api/test-logs

# æˆ–ä½¿ç”¨æµ‹è¯•è„šæœ¬
./test-elk-logs.sh
```

ç­‰å¾… 10-15 ç§’åŽï¼Œåœ¨ Kibana ä¸­å³å¯çœ‹åˆ°æ–°çš„æ—¥å¿—æ•°æ®ã€‚
